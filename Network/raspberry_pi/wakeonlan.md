## Windows10を外出先から遠隔起動するためにやったこと( Wake on LAN )

最近、自宅のメインPC( Windows10Pro )にリモートデスクトップ接続して外出先でも作業ができるように環境を作った。

わずかに操作遅延はある気もするが、それほど気にならず、かなり快適作業できるので気に入っている。

ただ一点不安なことがあった。

「これメインのPCの電源落ちたら、詰むやん」

これだけが本当に怖かった。電源が切れたりフリーズしたら作業続行できないと思っていたので、ホストPCが落ちた際の解決策が欲しかった。

Wake on LANという方法を使えばホストPCの電源を遠隔操作でonできると教わったので、試してみた。

### 環境
ホストPC( メインPC ): Window10Pro -> 有線LAN接続 ( マザボ: ASROCK B450 steal legend )

クライアントPC: thinkpadE14Gen4 Windows11Home -> 外部でリモートデスクトップ作業

ラズパイzero2w -> wifi接続でホストPCと同一ネットワークに所属

今回の場合、大前提として、グローバルIPアドレスがあり、ラズパイに外部からSSHできる環境が前提になる。

### 準備
#### BIOS UEFI
BIOS/UEFIの設定を行う必要がある。

自分の場合は、マザボがASROCK B450 steal legendだったので、UEFIの`Advanced > ACPI Configuration > PCIE Devices Power On`を`Enabled`に変更。

`Advanced > ACPI Configuration > Deep Sleep`は`Disabled`にするようだが、defaultでDisabledなのでOK

Save and ExitでUEFI終了

#### Windows( host )側 
- `Win + X`で開かれるメニューから「デバイスマネージャー」を選択
- 「ネットワークドライバ」 > 「Realtek PCIe GbE Family Controller」（これは人それぞれ違う可能性あり。）を右クリック > 「オプション」
- 「詳細設定」タブ内にwake on lan とか ウェイクオンラン、みたいな設定項目があるか確認
  - ある場合 -> それらを「有効」/ 「Enable」に変更
  - ない場合 -> ドライバの更新が必要と思われる。
    - 自分の場合はドライバの更新、WindowsUpdateをして最新状態にしたはずだが、NICのドライバのバージョンが古いままだった
    - Realtekのページに行き、最新版のドライバをダウンロードし、インストール。先ほど開いていたオプションの「ドライバ」タブの更新履歴を確認し、最新版が当たったことを確かめる
- オプション内、「電源の管理」タブ > 「このデバイスで、コンピュータのスタンバイ状態を解除できるようにする」、「Magic Packetでのみ、コンピュータのスタンバイ状態を解除できるようにする」をチェック
- コントロールパネルを開く
- ハードウェアとサウンド >> 電源オプション >> 電源ボタンの動作の変更 >> 「現在利用可能でない設定を変更します」クリック >> 「高速スタートアップを有効にする」のチェックをはずす
- MACアドレスを調べる
  - ipconfig /all
  - 「イーサネットアダプタ イーサネット」の欄の「物理アドレス」がMACアドレス`XX-XX-XX-XX-XX-XX`の形になっているが、ラズパイ側からMACアドレスを使用する際は`XX:XX:XX:XX:XX:XX`というようにコロン区切りなので注意

#### ラズパイ側
クライアントPCからSSH接続できるのは大前提としておきます。

wakeonlanのpackageをinstall `sudo apt install wakeonlan`

以上

### 動作確認
- クライアントPCを携帯のテザリングなどを使用して、外部ネットワークに接続させておく
- クライアントPCからホストPCにリモートデスクトップ接続を行い、その中でホストPCの電源をシャットダウンさせる
- リモートデスクトップ接続は解除され、ssh接続も当然切れます。
- クライアントPC -> ラズパイ へssh
- ラズパイにて`wakeonlan XX:XX:XX:XX:XX:XX<先ほど控えておいたホストPCのMACアドレス>`実行
- ホストPC起動( やった～ )

### トラブルシューティング
ラズパイから`wakeonlan XX:XX:XX:XX:XX:XX`を実行してもシャットダウン状態またはスリープ状態から復帰しない場合

考えられる原因
- raspberrypiのwakeonlan周辺のパッケージのバージョン問題
  - `sudo apt update`
  - `sudo apt upgrade`
  - 再度wakeonlan実行してみる。
- WindowsUpdateなどの影響で、UEFIの設定がリセットされているケースがあったので、UEFIに入って、上で設定したUEFIの設定変更をもう一度行う。
  - WindowsのBIOSモードがレガシでなく、UEFIの場合
    1. Shiftを押しながら、再起動
    2. トラブルシューティング
    3. 詳細オプション
    4. UEFIファームウェア設定
    5. 再起動


